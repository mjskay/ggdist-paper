---
title: "Figures for the ggdist paper"
author: "Matthew Kay"
date: "2023-03-11"
output: html_document
---

## Introduction

This document generates the various figures for the paper, *ggdist: Visualizations of Distributions and Uncertainty in the Grammar of Graphics*.

## Setup

These libraries are needed to build this file:

```{r setup}
library(ggplot2)
library(ggdist)              # obviously
library(distributional)      # for dist_...
library(dplyr)               # for data manipulation
library(systemfonts)         # for using system fonts
library(brms)
library(posterior)           # rvar
library(colorspace)          # continuous color palettes
```

And this ggplot theme, based on `theme_ggdist()`, using the Source Sans Pro font (in the `fonts/` folder):

```{r}
theme_set(
  theme_light(base_family = "Source Sans Pro") + theme(
    axis.line.x = element_line(color = "gray70", linewidth = rel(0.5)), 
    axis.line.y = element_line(color = "gray70", linewidth = rel(0.5)),
    axis.title.x = element_text(margin = margin(t = 7)), 
    axis.title.y = element_text(margin = margin(r = 7)), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(),
    strip.text = element_text(color = "black", margin = margin(6, 6, 6, 6)),
    strip.background = element_rect(fill = "gray90")
  )
)
```

And some functions we'll use for annotating stuff:

```{r}
red_ = "#d95f02"
label_color = red_

bracket_ = function(..., x, xend = x, y, yend = y, color = label_color) {
  annotate("segment",
    arrow = arrow(angle = 90, ends = "both", length = unit(3, "points")),
    color = color, linewidth = 0.75,
    x = x, xend = xend, y = y, yend = yend,
    ...
  )
}
arrow_ = function(..., curvature = 0, x, xend = x, y, yend = y, color = label_color) {
  annotate("curve", 
    color = color, arrow = arrow(angle = 45, length = unit(3, "points"), type = "closed"),
    curvature = curvature,
    x = x, xend = xend, y = y, yend = yend
  )
}
label_ = function(..., hjust = 0, color = label_color) {
  annotate("text",
    color = color, hjust = hjust, lineheight = 1,
    size = 3.75,
    ...
  )
}
```

And color palettes:

```{r}
# sequential version of COlorBrewer Blues that ends in white
sequential_hcl(n = 7, h = 245, c = c(50, 75, NA), l = c(20, 100), power = 0.8, register = "Blue-White")
```



## Setting the stage

### A simplified notation for the grammar of graphics

We're going to use a slightly modified version of the mtcars dataset:

```{r cars}
cars = mtcars |>
  mutate(weight = wt)
```

We can generate a nice scatterplot of it:

```{r 2-mpg_v_weight, fig.height = 2, fig.width = 2.5}
p = cars |>
  ggplot(aes(x = weight, y = mpg)) +
  geom_point()
p

ggsave("figs/2-mpg_v_weight.pdf", device = cairo_pdf)
```

### Uncertainty as she is spoke

```{r 2-mean_sd_interval, fig.height = 1.25, fig.width = 2.5}
p = data.frame(a = dist_normal(0, 1)) |>
  ggplot(aes(xdist = a)) +
  stat_pointinterval(.width = .95) +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL, limits = c(-2.95, 2.95)) +
  label_(label = "italic(a)", x = 0, y = 0.19, hjust = 0.5, parse = TRUE) +
  bracket_(x = 0, xend = 1, y = -0.18) +
  label_(label = "italic(sigma[a])", x = 0.5, y = -0.34, hjust = 0.5, parse = TRUE) +
  labs(y = NULL, x = NULL)

p
ggsave("figs/2-mean_sd_interval.pdf", device = cairo_pdf)
```

```{r 2-xmin_xmax_interval, fig.height = 1.25, fig.width = 2.5}
p = data.frame(a = dist_normal(0, 1)) |>
  ggplot(aes(xdist = a)) +
  stat_pointinterval(.width = .95, justification = 0.55) +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL, limits = c(-2.95, 2.95)) +
  label_(label = "italic(a)", x = 0, y = 0.17, hjust = 0.5, parse = TRUE) +
  arrow_(x = -1.96, y = -0.2, yend = -0.06) +
  label_(label = "italic(a - 1.96%.%sigma[a])", x = -1.96, y = -0.32, hjust = 0.5, parse = TRUE) +
  arrow_(x = 1.96, y = -0.2, yend = -0.06) +
  label_(label = "italic(a + 1.96%.%sigma[a])", x = 1.96, y = -0.32, hjust = 0.5, parse = TRUE) +
  labs(y = NULL, x= NULL) 

p
ggsave("figs/2-xmin_xmax_interval.pdf", device = cairo_pdf)
```

## Distributional vis

### Intervals

```{r 3-geom_pointinterval_quantiles, fig.height = 1.5, fig.width = 2.5}
p = data.frame(a = dist_normal(0, 1)) |>
  ggplot(aes(xdist = a)) +
  stat_pointinterval(.width = .95, justification = 0.65) +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL, limits = c(-2.95, 2.95)) +
  label_(label = "median(italic(A))", x = 0, y = 0.15, hjust = 0.5, parse = TRUE) +
  arrow_(x = -1.96, y = -0.2, yend = -0.04) +
  label_(label = "{italic(F)[italic(A)]^{-1}}~bgroup('(', over(1 - gamma, 2), ')')", x = -1.96, y = -0.42, hjust = 0.5, parse = TRUE) +
  arrow_(x = 1.96, y = -0.2, yend = -0.04) +
  label_(label = "{italic(F)[italic(A)]^{-1}}~bgroup('(', over(1 + gamma, 2), ')')", x = 1.96, y = -0.42, hjust = 0.5, parse = TRUE) +
  labs(y = NULL, x = NULL)

p
ggsave("figs/3-geom_pointinterval_quantiles.pdf", device = cairo_pdf)
```

```{r 3-stat_pointinterval_linewidth, fig.height = 2.5, fig.width = 2.5}
p = data.frame(a = dist_normal(0, 1)) |>
  ggplot(aes(xdist = a)) +
  stat_pointinterval() +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL, limits = c(-2.5, 2.5)) +
  bracket_(x = -1.96, xend = 1.96, y = 0.07) +
  label_(label = "γ = 0.95", x = -1.72, y = 0.12, hjust = 0, vjust = 0) +
  bracket_(x = -0.95, xend = 0.95, y = -0.07) +
  label_(label = "γ = 0.66", x = -0.67, y = -0.12, hjust = 0, vjust = 1) +
  labs(y = NULL, x = NULL)

p
ggsave("figs/3-stat_pointinterval_linewidth.pdf", device = cairo_pdf)
```

```{r 3-stat_pointinterval_color, fig.height = 1.5, fig.width = 2.5}
p = data.frame(a = dist_normal(0, 1)) |>
  ggplot(aes(xdist = a)) +
  stat_pointinterval(aes(interval_color = after_stat(level)), linewidth = 18, .width = c(.5, .8, .95)) +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL, limits = c(-2.5, 2.5)) +
  scale_color_brewer(aesthetics = "interval_color") +
  labs(y = NULL, x = NULL, interval_color = "mass")

p
ggsave("figs/3-stat_pointinterval_color.pdf", device = cairo_pdf)
```


```{r 3-stat_pointinterval_A, fig.height = 2, fig.width = 2.5}
p = data.frame(a = dist_normal(0, 1)) |>
  ggplot(aes(xdist = a)) +
  stat_pointinterval() +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL, limits = c(-2.5, 2.5)) +
  label_(label = "A", x = 0, y = 0.15, hjust = 0.5, vjust = 1) +
  labs(y = NULL, x = NULL)

p
ggsave("figs/3-stat_pointinterval_A.pdf", device = cairo_pdf)
```

```{r 3-stat_pointinterval_normal, fig.height = 2, fig.width = 2.5}
p = data.frame(a = dist_normal(0, 1)) |>
  ggplot(aes(xdist = a)) +
  stat_pointinterval() +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL, limits = c(-2.5, 2.5)) +
  label_(label = "Normal(italic(a), italic(sigma[a]))", x = 0, y = 0.15, hjust = 0.5, vjust = 1, parse = TRUE) +
  labs(y = NULL, x = NULL)

p
ggsave("figs/3-stat_pointinterval_normal.pdf", device = cairo_pdf)
```

```{r 3-stat_pointinterval_student_t, fig.height = 1, fig.width = 2.5}
p = data.frame(a = dist_student_t(6, 0, 1)) |>
  ggplot(aes(xdist = a)) +
  stat_pointinterval() +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL, limits = c(-2.5, 2.5)) +
  label_(label = "italic(t[nu[a]])(italic(a), italic(sigma[a]))", x = 0, y = 0.35, hjust = 0.5, vjust = 1, parse = TRUE) +
  labs(y = NULL, x = NULL)

p
ggsave("figs/3-stat_pointinterval_student_t.pdf", device = cairo_pdf)
```

### Ribbons

Build the model:

```{r}
m_mpg = brm(
  mpg ~ weight, 
  family = lognormal, 
  data = cars, 
  iter = 5000, 
  cores = 4, 
  save_model = "models/m_mpg.rds"
)
```
```{r}
preds = data.frame(weight = seq(min(cars$weight), max(cars$weight), length.out = 100))
preds = preds |>
  mutate(mpg_given_weight = rvar(posterior_predict(m_mpg, preds)))
preds
```

Now the vis:

```{r 3-lineribbon, fig.width = 2.5, fig.height = 2}
p = preds |>
  ggplot(aes(x = weight)) +
  stat_lineribbon(aes(ydist = mpg_given_weight), linewidth = 0.75) +
  geom_point(aes(y = mpg), data = cars, color = alpha("black", 0.75), stroke = 0.5, shape = 21, fill = alpha("gray85", 0.5)) +
  scale_fill_brewer() +
  guides(fill = "none")

p
ggsave("figs/3-lineribbon.pdf", device = cairo_pdf)
```

lineribbon fan:

```{r 3-lineribbon_fan, fig.width = 2.5, fig.height = 2}
p = preds |>
  ggplot(aes(x = weight)) +
  stat_lineribbon(aes(ydist = mpg_given_weight, fill = after_stat(.width)), linewidth = 0.75, .width = ppoints(100)) +
  geom_point(aes(y = mpg), data = cars, color = alpha("black", 0.75), stroke = 0.5, shape = 21, fill = alpha("gray85", 0.5)) +
  colorspace::scale_fill_continuous_sequential(palette = "Blue-White", rev = FALSE) +
  guides(fill = "none")

p
ggsave("figs/3-lineribbon_fan.pdf", device = cairo_pdf)
```

### Slabs

```{r slab_density_two_groups, fig.width = 2.5, fig.height = 2}
two_a = data.frame(
  nu = c(5, 60),
  mu = c(6, 1),
  sigma = c(1.3, 1.1),
  group = factor(c("a", "b"))
)

p = two_a |>
  ggplot(aes(xdist = dist_student_t(nu, mu, sigma), y = group)) +
  stat_slab() +
  # stat_spike(
  #   at = c(1, 1.8, 2.6, 3.4, 4.2),
  #   data = \(d) filter(d, group == 2),
  #   size = NA,
  #   arrow = arrow(angle = 90, length = unit(3, "pt")),
  #   color = label_color,
  #   linewidth = 0.75
  # ) +
  bracket_(x = 14, y = 2, yend = 2.9) +
  bracket_(x = 14, y = 1, yend = 1.9) +
  label_(x = 13.5, y = 2.5, label = "thickness", fontface = "italic", hjust = 1, vjust = 0.9) +
  label_(x = 13.5, y = c(1, 2), label = "0", hjust = 1, vjust = 0.2) +
  label_(x = 13.5, y = c(1.9, 2.9), label = "max(italic(f[M](x)))", parse = TRUE, hjust = 1, vjust = 0.8) +
  scale_x_continuous(breaks = NULL, limits = c(-3, 14)) +
  scale_y_discrete(expand = expansion(0.15)) +
  labs(x = NULL)

p
ggsave("figs/3-slab_density_two_groups.pdf", device = cairo_pdf)
```

```{r slab_gradient_two_groups, fig.width = 2.5, fig.height = 1.5}
p = two_a |>
  ggplot(aes(xdist = dist_student_t(nu, mu, sigma), y = group)) +
  stat_slab(aes(alpha = !!p_(x)), thickness = 1, side = "both", fill_type = "gradient", scale = 0.7) +
  scale_x_continuous(breaks = NULL, limits = c(-3, 14)) +
  scale_y_discrete(expand = expansion(0.15)) +
  scale_alpha_continuous(range = c(0, 1), guide = "none") +
  labs(x = NULL)

p
ggsave("figs/3-slab_gradient_two_groups.pdf", device = cairo_pdf)
```

Correll gradients

```{r slab_gradient_correll, fig.width = 2.5, fig.height = 1.5}
p = two_a |>
  ggplot(aes(xdist = dist_student_t(nu, mu, sigma), y = group)) +
  stat_slab(aes(alpha = - pmax(abs(2*!!Pr_(X <= x) - 1), .95)), thickness = 1, side = "both", fill_type = "gradient", scale = 0.7) +
  scale_x_continuous(breaks = NULL, limits = c(-3, 14)) +
  scale_y_discrete(expand = expansion(0.15)) +
  scale_alpha_continuous(range = c(0, 1), guide = "none") +
  labs(x = NULL)

p
ggsave("figs/3-slab_gradient_correll.pdf", device = cairo_pdf)
```

Helske violin gradients

```{r slab_violin_gradient, fig.width = 2.5, fig.height = 1.5}
p = two_a |>
  ggplot(aes(xdist = dist_student_t(nu, mu, sigma), y = group)) +
  stat_slab(aes(alpha = - pmax(abs(2*!!Pr_(X <= x) - 1), .95)), side = "both", fill_type = "gradient") +
  scale_x_continuous(breaks = NULL, limits = c(-3, 14)) +
  scale_y_discrete(expand = expansion(0.15)) +
  scale_alpha_continuous(range = c(0, 1), guide = "none") +
  labs(x = NULL)

p
ggsave("figs/3-slab_violin_gradient.pdf", device = cairo_pdf)
```

Helske-like violin intervals:

```{r slab_violin_interval, fig.width = 2.5, fig.height = 1.5}
p = two_a |>
  ggplot(aes(xdist = dist_student_t(nu, mu, sigma), y = group)) +
  stat_slab(aes(alpha = after_stat(level)), side = "both", fill_type = "gradient", .width = c(.5, .8, .95, .99, 1)) +
  scale_x_continuous(breaks = NULL, limits = c(-3, 14)) +
  scale_y_discrete(expand = expansion(0.15)) +
  guides(alpha = "none") +
  labs(x = NULL)

p
ggsave("figs/3-slab_violin_interval.pdf", device = cairo_pdf)
```

Raindrop plots:

```{r slab_raindrop, fig.width = 2.5, fig.height = 1.5}
p = two_a |>
  ggplot(aes(xdist = dist_student_t(nu, mu, sigma), y = group)) +
  stat_eye(aes(thickness = after_stat(ifelse(.width <= .95, log(pdf), NA))), normalize = "groups", side = "both") +
  scale_x_continuous(breaks = NULL, limits = c(-3, 14)) +
  scale_y_discrete(expand = expansion(0.15)) +
  guides(alpha = "none") +
  labs(x = NULL)

p
ggsave("figs/3-slab_violin_interval.pdf", device = cairo_pdf)
```

## Session Info

This file was built with the following setup:

```{r session info}
sessionInfo()
```
